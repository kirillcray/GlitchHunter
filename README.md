# GlitchHunter

## Описание
GlitchHunter — это инструмент для анализа изображений и обнаружения аномалий с использованием различных моделей и методов обработки данных. Проект включает в себя модули для работы с камерами, обработки изображений, а также интеграцию с библиотекой Anomalib для анализа аномалий.

## Установка

### 1. Клонирование репозитория
Сначала клонируйте репозиторий Anomalib, так как он необходим для работы проекта:
```bash
cd anomalib
git clone https://github.com/open-edge-platform/anomalib/
```

### 2. Установка зависимостей
Установите зависимости, указанные в файле `requirements.txt`:
```bash
pip install -r requirements.txt
```

### 3. Для работы предобученной модели MonSter необходимо скачать и поместить веса в папку MonSter/pretrained

    [mix_all.pth](https://huggingface.co/cjd24/MonSter/resolve/main/mix_all.pth?download=true)

    [Depth-Anything-V2-Large](https://huggingface.co/depth-anything/Depth-Anything-V2-Large/resolve/main/depth_anything_v2_vitl.pth?download=true)

## Структура проекта

- `anomalib/` — содержит скрипты для обучения и использования модели для анализа аномалий.
- `MonSter/` — модуль для построения карты глубины с использованием стереокамер.
- `OpenCV/` — модули для работы с камерами и калибровки.
- `image_processing_for_anomalib/` — скрипт для обрезки и нормализации изображений.
- `united.py` — основной скрипт для запуска всего процесса.

---

### Модуль `anomalib`
**Описание**: Модуль для анализа аномалий с использованием предобученных моделей.

- **`test_anomaly_detector.py`**: Скрипт для тестирования модели на новых данных.
- **`train_patchcore.py`**: Скрипт для обучения модели PatchCore.
- **`datasets/`**: Папка для хранения данных, организованных по структуре `good`, `bad`, `test`.
- **`results/`**: Папка для хранения результатов обучения и тестирования.

---

### Модуль `MonSter`
**Описание**: Модуль для работы с картами глубины, построенными на основе стереоизображений. Возвращает карту глубины в формате img и npy. Npy нужен для более удобной последующей обработки.

- **`save_disp.py`**: Генерация карт глубины из стереоизображений.

**Пример использования**:
```bash
python MonSter/save_disp.py --left_imgs path/to/left/*.png --right_imgs path/to/right/*.png --output_directory path/to/output
```

---

### Модуль `image_processing_for_anomalib`
**Описание**: Утилиты для обработки изображений перед анализом аномалий. Принимает карту глубины в виде numpy массива, после чего обрезает изображение по заданным координатам и повышает контрастность изображения путем нормализации minmax.

- **`image_processing.py`**: Скрипт для нормализации и обрезки изображений.

**Пример использования**:
```bash
python image_processing_for_anomalib/image_processing.py --input_path path/to/input --output_path path/to/output --coord_min 300 290 --coord_max 810 910
```

---

### Модуль `OpenCV`
**Описание**: Модуль для работы с камерами и калибровки.

- **`cam_read.py`**: Съемка изображений с камер.
- **`stereo_rectify.py`**: Выравнивание изображений с использованием результатов калибровки
- **`cam_calibration.py`**: Калибровка отдельных камер.
- **`stereo_calibration.py`**: Стереокалибровка для работы с двумя камерами.
- **`depth_map.py`**: Генерация карт глубины с помощью OpenCV.

**Пример использования**:
```bash
python OpenCV/cam_read.py
```

---

## Использование

### 1. Запуск основного скрипта
Для запуска основного процесса используйте файл `united.py`. Он выполняет следующие шаги:

1. Создаёт новую директорию для хранения результатов.
2. Снимает фотографии с камер и сохраняет их.
3. Обрабатывает изображения с помощью модуля MonSter.
4. Нормализует изображения.
5. Запускает Anomalib для анализа аномалий.

Запустите скрипт командой:
```bash
python united.py
```

### 2. Настройка параметров

### Калибровка камер

1. Для калибровки отдельных камер, для начала нужно сделать 10+ снимков шахматной доски 9х6 с каждой камеры. Старайтесь захватить каждый участок камеры доской для более точной калибровки. Все снимки сохранятся в папку по умолчанию `screenshot/cam_left` или `screenshot/cam_right`. Названия снимков задаются по времени их созданию (чч-мм-сс). Используйте `cam_read.py`:
    ```sh
    python cam_read.py
    ```

2. Для калибровки камеры используйте `cam_calibration.py`. По очереди запустите скрипт для левой и правой камеры:
    ```sh
    python cam_calibration.py
    ```
    Результат калибровки будет сохранён в папку [calib/] по умолчанию

3. После калибровки каждой камеры по отдельности необходимо выполнить стереокалибровку. Сделайте еще 10-15 снимков, обращая внимание на то, чтобы доску было видно на каждой камере. Для калибровки стереопары используйте [stereo_calibration.py]:
    ```sh
    python stereo_calibration.py
    ```

### Обучение Anomalib.

### 1. Подготовка фотографий

#### Съемка фотографий
1. Для съемки фотографий используйте скрипт `cam_read.py`. Запустите его командой:
   ```bash
   python OpenCV/cam_read.py
   ```
   - Скрипт инициализирует левую и правую камеры.
   - Снимки сохраняются по умолчанию в папки `screenshot/cam_left` и `screenshot/cam_right`.
   - Убедитесь, что шахматная доска или объект съемки видны на обеих камерах.

2. Для получения качественных данных сделайте не менее 30 снимков для нормальных объектов (без дефектов) и несколько снимков с дефектами.

#### Обработка фотографий
1. После съемки фотографий используйте скрипт `save_disp.py` из папки MonSter для создания карт глубины. Запустите следующую команду:
   ```bash
   python MonSter/save_disp.py --left_imgs путь_к_левым_фотографиям/*.png --right_imgs путь_к_правым_фотографиям/*.png --output_directory путь_для_сохранения_карт_глубины
   ```
   - Укажите пути к папкам с левыми и правыми изображениями.
   - Карты глубины будут сохранены в указанной директории.

2. Для обрезки изображений до интересующей области и повышения контрастности используйте скрипт `image_processing.py`. Пример вызова:
   ```bash
   python image_processing_for_anomalib/image_processing.py --input_path путь_к_картам_глубины --output_path путь_для_сохранения_обработанных_изображений --coord_min 300 290 --coord_max 810 910
   ```
   - Укажите координаты области, которую нужно обрезать, с помощью параметров `--coord_min` и `--coord_max`.
   - Обработанные изображения будут сохранены в указанной папке.


### 3. Обучение модели Anomalib

Для обучения модели Anomalib выполните следующие шаги:

1. **Подготовка данных:**
   - Убедитесь, что ваши данные организованы в следующей структуре:
     ```
     datasets/
       my_board/
         good/  # Папка с изображениями без дефектов
         bad/   # Папка с изображениями с дефектами
         test/  # Папка с тестовыми изображениями
     ```

2. **Запуск обучения:**
   - Используйте скрипт `train_patchcore.py` для обучения модели. Запустите следующую команду:
     ```bash
     python anomalib/train_patchcore.py
     ```
   - Убедитесь, что путь к данным и другие параметры указаны правильно в скрипте.

3. **Результаты обучения:**
   - После завершения обучения результаты будут сохранены в папке `anomalib/results/patchcore/my_board/`. В этой папке вы найдете веса модели, метрики и визуализации.

4. **Использование обученной модели:**
   - Для использования обученной модели укажите путь к контрольной точке (например, `weights/lightning/model.ckpt`) в скрипте `united.py` или в других скриптах для анализа.

#### Параметры обработки изображений
Для изменения области нормализации изображений отредактируйте аргументы `coord_min` и `coord_max` в функции `preprocess_image` в `united.py`.

#### Параметры Anomalib
Путь к контрольной точке модели (`checkpoint_path`) и другие параметры можно настроить в вызове функции `run_anomalib` в `united.py`.

## Пример структуры выходных данных
После выполнения скрипта `united.py` результаты будут сохранены в папке `result/` с текущей датой и версией. Пример структуры:
```
result/
  2025-04-25/
    v1/
      rectified_images/
      MonSter/
      cropped_images/
      anom/
```

## Примечания
- Убедитесь, что у вас установлены все необходимые зависимости.
- Проверьте, что камеры подключены и правильно настроены.
- Для работы с MonSter требуется GPU для ускорения вычислений.
- Использовался Anomalib v2.0.0 для корректной работы, лучше установить эту же версию
## Ошибки и отладка
- Если не получается подключиться к камерам, нужно попробовать поменять cam_port. Обычно они равны 0 и 1, но если подключены еще некоторые камеры значения могут отличаться.
- Нужно перепроверять что левая камера действительно является левой, а правая является правой. При выводе изображений окна соответсвенно подписаны cam_left и cam_right
